# 第一阶段：构建前端
FROM node:18-alpine AS front
ARG VERSION
WORKDIR /app
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
RUN apk add --no-cache git
RUN corepack enable
RUN git clone --depth=1 https://github.com/kingwrcy/mblog-front.git
WORKDIR /app/mblog-front
RUN yarn install --registry=https://registry.npm.taobao.org
RUN sed -i 's#REPLACE_VERSION_HERE#'"$VERSION"'#g' .env.all
RUN yarn build-only --mode=all

# 第二阶段：构建Java应用 - 手动安装Maven
FROM eclipse-temurin:17-jdk-alpine AS builder
WORKDIR /build

# 安装Maven
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk add --no-cache maven

COPY pom.xml .
RUN mvn dependency:go-offline -B
COPY src ./src
RUN mvn clean package -DskipTests

# 第三阶段：最终运行镜像
FROM openjdk:17-alpine
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk update && \
    apk add busybox-extras && \
    apk add tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    apk del tzdata

# 从构建阶段复制JAR文件
COPY --from=builder /build/target/memo-0.0.1-SNAPSHOT.jar /app/memo-0.0.1-SNAPSHOT.jar
# 从构建阶段复制配置文件
COPY --from=builder /build/target/classes/*.properties /app/
# 从前端构建阶段复制静态资源
COPY --from=front /app/mblog-front/dist /app/static

ENV JAVA_OPTS="-Xms512m -Xmx512m"
ENV DB_TYPE=""
ENV MBLOG_EMBED=true

CMD java $JAVA_OPTS -jar /app/memo-0.0.1-SNAPSHOT.jar --spring.config.location=/app/application$DB_TYPE.properties
